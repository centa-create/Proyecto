{% extends 'base.html' %}
{% block title %}Panel de Administración | Tienda Virtual{% endblock %}
{% block head %}
<style>
    .sidebar {
        background: linear-gradient(135deg, #181c24 0%, #2a2a3a 100%);
        color: #fff;
        min-height: 100vh;
        padding-top: 2rem;
        box-shadow: 0 0 32px rgba(255,255,255,0.1);
        border-right: 2px solid rgba(255,255,255,0.1);
        position: relative;
        overflow: hidden;
    }
    .sidebar::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 20% 80%, rgba(255,255,255,0.05) 0%, transparent 50%);
        animation: sidebarGlow 8s ease-in-out infinite alternate;
    }
    @keyframes sidebarGlow {
        0% { opacity: 0.3; }
        100% { opacity: 0.6; }
    }
    .sidebar a {
        color: #fff;
        display: block;
        padding: 1rem 1.5rem;
        text-decoration: none;
        border-radius: 12px;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    .sidebar a::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s ease;
    }
    .sidebar a:hover::before {
        left: 100%;
    }
    .sidebar a.active, .sidebar a:hover {
        background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
        color: #fff;
        box-shadow: 0 0 20px rgba(255,255,255,0.3), inset 0 0 20px rgba(255,255,255,0.1);
        transform: translateX(10px);
        border-left: 4px solid #fff;
    }
    .main-panel {
        padding: 2rem;
    }
    .admin-badge {
        background: linear-gradient(90deg,#fff,#eaeaea);
        color: #23272f;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-weight: bold;
        margin-bottom: 1rem;
        display: inline-block;
        box-shadow: 0 0 12px #fff8;
    }
    .card {
        border-radius: 1.5rem;
        box-shadow: 0 0 24px rgba(255,255,255,0.1), 0 8px 32px rgba(0,0,0,0.3);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        position: relative;
        overflow: hidden;
    }
    .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        transition: left 0.6s ease;
    }
    .card:hover::before {
        left: 100%;
    }
    .card:hover {
        transform: translateY(-8px) rotateX(5deg) rotateY(5deg) scale(1.05);
        box-shadow: 0 20px 40px rgba(255,255,255,0.2), 0 0 60px rgba(255,255,255,0.1);
    }
    .card-body {
        position: relative;
        z-index: 2;
    }
    .table-dark {
        background: linear-gradient(135deg, #23272f 0%, #2a2a3a 100%);
        color: #fff;
        border-radius: 1.5rem;
        box-shadow: 0 0 20px rgba(255,255,255,0.1);
        overflow-x: auto;
        display: block;
        max-width: 100%;
        border: 2px solid rgba(255,255,255,0.1);
        backdrop-filter: blur(10px);
    }
    .table-dark th, .table-dark td {
        border-color: rgba(255,255,255,0.2);
        transition: all 0.3s ease;
    }
    .table-dark tr:hover {
        background: rgba(255,255,255,0.1);
        transform: scale(1.01);
        box-shadow: 0 0 15px rgba(255,255,255,0.2);
    }
    .table-dark th {
        background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
        border-bottom: 2px solid rgba(255,255,255,0.2);
    }
    .btn-warning.btn-sm {
        background: linear-gradient(90deg,#fff,#eaeaea);
        color: #23272f;
        border: 2px solid #fff;
        font-weight: 700;
        border-radius: 8px;
        box-shadow: 0 0 8px #fff8;
        transition: background 0.2s, color 0.2s;
    }
    .btn-warning.btn-sm:hover {
        background: #23272f;
        color: #fff;
        box-shadow: 0 0 16px #fff;
    }
    .admin-particles {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        z-index: -1;
        overflow: hidden;
    }
    .admin-particle {
        position: absolute;
        width: 3px;
        height: 3px;
        background: rgba(255,255,255,0.6);
        border-radius: 50%;
        animation: adminFloat 15s infinite linear;
    }
    @keyframes adminFloat {
        0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
    }
    #admin-notifications {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
    }
    .admin-notification {
        background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 12px;
        padding: 1rem 1.5rem;
        margin-bottom: 10px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        transform: translateX(400px);
        transition: transform 0.3s ease;
        max-width: 300px;
    }
    .admin-notification.show {
        transform: translateX(0);
    }
    .admin-notification-content {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .admin-notification-icon {
        font-size: 1.25rem;
        flex-shrink: 0;
    }
    .admin-notification-text {
        font-weight: 500;
        color: #1e293b;
        line-height: 1.4;
    }
    .admin-notification-success .admin-notification-icon {
        color: #10b981;
    }
    .admin-notification-error .admin-notification-icon {
        color: #ef4444;
    }
    .admin-header {
        position: relative;
        overflow: hidden;
        margin-bottom: 2rem;
        border-radius: 1.5rem;
        background: linear-gradient(135deg, rgba(24,24,24,0.8), rgba(42,42,42,0.8));
        border: 2px solid rgba(255,255,255,0.1);
        box-shadow: 0 0 30px rgba(255,255,255,0.1);
    }
    .waves {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
    }
    .wave {
        animation: waveMove 10s ease-in-out infinite;
    }
    .wave:nth-child(1) { animation-delay: 0s; }
    .wave:nth-child(2) { animation-delay: 2s; }
    .wave:nth-child(3) { animation-delay: 4s; }
    @keyframes waveMove {
        0%, 100% { transform: translateX(0) translateZ(0) scaleY(1); }
        50% { transform: translateX(-25%) translateZ(0) scaleY(0.8); }
    }
    .admin-header-content {
        position: relative;
        z-index: 2;
        padding: 2rem;
        text-align: center;
    }
    .admin-clock {
        position: absolute;
        top: 1rem;
        left: 1rem;
        font-size: 1.5rem;
        font-weight: bold;
        color: #fff;
        background: rgba(0,0,0,0.5);
        padding: 0.5rem 1rem;
        border-radius: 1rem;
        border: 2px solid rgba(255,255,255,0.2);
        box-shadow: 0 0 15px rgba(255,255,255,0.3);
        font-family: 'Courier New', monospace;
    }
    .sidebar-toggle {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: rgba(255,255,255,0.1);
        border: 2px solid rgba(255,255,255,0.2);
        color: #fff;
        border-radius: 8px;
        padding: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 10;
    }
    .sidebar-toggle:hover {
        background: rgba(255,255,255,0.2);
        box-shadow: 0 0 15px rgba(255,255,255,0.3);
    }
    .fullscreen-toggle {
        position: absolute;
        top: 1rem;
        right: 4rem;
        background: rgba(255,255,255,0.1);
        border: 2px solid rgba(255,255,255,0.2);
        color: #fff;
        border-radius: 8px;
        padding: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 10;
    }
    .fullscreen-toggle:hover {
        background: rgba(255,255,255,0.2);
        box-shadow: 0 0 15px rgba(255,255,255,0.3);
    }
    .sidebar.collapsed {
        width: 80px;
        transition: width 0.3s ease;
    }
    .sidebar.collapsed h4,
    .sidebar.collapsed a {
        opacity: 0;
        pointer-events: none;
    }
    .main-panel.expanded {
        margin-left: 80px;
        transition: margin-left 0.3s ease;
    }
    @media (max-width: 768px) {
        .sidebar {
            min-height: auto;
            padding: 1rem 0.5rem;
        }
        .main-panel {
            padding: 1rem;
        }
        .table-dark {
            font-size: 0.95rem;
        }
    }
</style>
{% endblock %}
{% block content %}
<div class="admin-particles"></div>
<div id="admin-notifications"></div>
<div class="container-fluid">
    <div class="row">
        <nav class="col-md-3 col-lg-2 sidebar" id="admin-sidebar">
            <button class="sidebar-toggle" id="sidebar-toggle">☰</button>
            <h4 class="mb-4">Panel de Administración</h4>
            <a href="{{ url_for('admin.dashboard') }}" class="active">Dashboard</a>
            <a href="{{ url_for('admin.orders') }}">Pedidos</a>
            <a href="{{ url_for('admin.returns') }}">Devoluciones</a>
            <a href="{{ url_for('admin.coupons') }}">Cupones</a>
            <a href="{{ url_for('admin.audit') }}">Auditoría</a>
            <a href="{{ url_for('admin.store_config') }}">Configuración</a>
            <a href="{{ url_for('admin.admin_notifications') }}">Notificaciones</a>
            <a href="{{ url_for('admin.banners') }}">Banners</a>
            <a href="{{ url_for('admin.support_tickets') }}">Soporte/Tickets</a>
            <a href="{{ url_for('admin.products') }}">Productos</a>
            <a href="{{ url_for('admin.categories') }}">Categorías</a>
            <a href="{{ url_for('admin.inventory') }}">Inventario</a>
            <a href="{{ url_for('admin.reports') }}">Reportes</a>
            <div class="mt-2 ms-2">
                <a href="{{ url_for('admin.export_users') }}" class="btn btn-sm btn-outline-info">Exportar Usuarios</a>
                <a href="{{ url_for('admin.export_products') }}" class="btn btn-sm btn-outline-info">Exportar Productos</a>
                <a href="{{ url_for('admin.export_orders') }}" class="btn btn-sm btn-outline-info">Exportar Pedidos</a>
            </div>
            <a href="{{ url_for('auth.logout') }}">Cerrar sesión</a>
        </nav>
        <main class="col-md-9 col-lg-10 main-panel">
            <div class="admin-header">
                <svg class="waves" xmlns="http://www.w3.org/2000/svg" viewBox="0 24 150 28" preserveAspectRatio="none">
                    <defs>
                        <path id="wave" d="M-160,44c30,0,58-18,88-18s58,18,88,18s58-18,88-18s58,18,88,18v44h-352z"/>
                    </defs>
                    <g class="wave-container">
                        <use href="#wave" class="wave" x="48" y="0" fill="rgba(255,255,255,0.1)"/>
                        <use href="#wave" class="wave" x="48" y="3" fill="rgba(255,255,255,0.05)"/>
                        <use href="#wave" class="wave" x="48" y="5" fill="rgba(255,255,255,0.03)"/>
                    </g>
                </svg>
                <div class="admin-header-content">
                    <div id="admin-clock" class="admin-clock">00:00:00</div>
                    <button class="fullscreen-toggle" id="fullscreen-toggle" title="Pantalla completa">⛶</button>
                    <span class="admin-badge">Modo Administrador</span>
                    <h2>Bienvenido, {{ current_user.nameUser }}</h2>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-md-4 mb-3">
                    <div class="card text-bg-primary animate__animated animate__pulse animate__infinite">
                        <div class="card-body">
                            <h5 class="card-title">Usuarios registrados</h5>
                            <p class="card-text display-6" id="usuarios-registrados">{{ usuarios_registrados }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card text-bg-success animate__animated animate__pulse animate__infinite animate__delay-1s">
                        <div class="card-body">
                            <h5 class="card-title">Estadísticas</h5>
                            <p class="card-text display-6" id="estadisticas">+{{ estadisticas }}%</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card text-bg-warning animate__animated animate__pulse animate__infinite animate__delay-2s">
                        <div class="card-body">
                            <h5 class="card-title">Notificaciones</h5>
                            <p class="card-text display-6" id="notificaciones">{{ notificaciones }}</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end mb-2">
                <button class="btn btn-primary" onclick="recargarDashboard()">Recargar datos</button>
            </div>
            <div class="alert alert-info mt-4">Esta es el área de notificaciones y mensajes importantes del sistema.</div>
            <div class="mt-4 p-3" style="background:#23272f;border-radius:1rem;box-shadow:0 0 12px #fff8;">
                <h5 class="mb-3">Estadísticas en tiempo real <span class="badge bg-success">Beta</span></h5>
                <div id="estadisticas-tiempo-real" style="color:#fff;">Cargando datos en tiempo real...</div>
                <canvas id="chart-ventas" height="80" style="max-width:100%;background:linear-gradient(135deg, #181c24 0%, #2a2a3a 100%);border-radius:1.5rem;border:2px solid rgba(255,255,255,0.1);box-shadow:0 0 20px rgba(255,255,255,0.1);"></canvas>
            </div>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script src="{{ url_for('static', filename='js/admin_charts.js') }}"></script>
            <script>
            // Función para crear partículas
            function createAdminParticles() {
                const container = document.querySelector('.admin-particles');
                if (!container) return;
                for (let i = 0; i < 30; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'admin-particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 15 + 's';
                    particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                    container.appendChild(particle);
                }
            }

            // Función para reproducir sonidos
            function playAdminSound(frequency, duration) {
                if ('AudioContext' in window || 'webkitAudioContext' in window) {
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                        oscillator.type = 'sine';

                        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + duration);
                    } catch (e) {
                        // Silenciar errores de audio
                    }
                }
            }

            // Función para mostrar notificaciones
            function showAdminNotification(message, type) {
                const container = document.getElementById('admin-notifications');
                const notification = document.createElement('div');
                notification.className = `admin-notification admin-notification-${type}`;
                notification.innerHTML = `
                    <div class="admin-notification-content">
                        <span class="admin-notification-icon">
                            ${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}
                        </span>
                        <span class="admin-notification-text">${message}</span>
                    </div>
                `;
                container.appendChild(notification);
                setTimeout(() => notification.classList.add('show'), 10);
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }, 4000);
                playAdminSound(type === 'success' ? 800 : 400, 0.2);
            }

            // Simulación de actualización en tiempo real (puedes conectar a WebSocket o AJAX real)
            function recargarDashboard() {
                document.getElementById('estadisticas-tiempo-real').innerText = 'Actualizando...';
                setTimeout(function() {
                    document.getElementById('estadisticas-tiempo-real').innerText = 'Usuarios activos: ' + (Math.floor(Math.random()*100)+10) + '\nVentas hoy: $' + (Math.floor(Math.random()*10000)+1000);
                    showAdminNotification('Dashboard actualizado exitosamente', 'success');
                }, 1200);
            }

            // Función para animar contadores
            function animateValue(element, start, end, duration) {
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    element.textContent = Math.floor(progress * (end - start) + start);
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    }
                };
                window.requestAnimationFrame(step);
            }

            // Función para toggle sidebar
            function toggleSidebar() {
                const sidebar = document.getElementById('admin-sidebar');
                const mainPanel = document.querySelector('.main-panel');
                sidebar.classList.toggle('collapsed');
                mainPanel.classList.toggle('expanded');
                playAdminSound(600, 0.15);
            }

            // Función para toggle fullscreen
            function toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                    playAdminSound(800, 0.2);
                } else {
                    document.exitFullscreen();
                    playAdminSound(400, 0.2);
                }
            }

            // Inicialización
            document.addEventListener('DOMContentLoaded', function() {
                createAdminParticles();
                recargarDashboard();

                // Event listeners
                document.getElementById('sidebar-toggle').addEventListener('click', toggleSidebar);
                document.getElementById('fullscreen-toggle').addEventListener('click', toggleFullscreen);

                // Función para actualizar reloj
                function updateClock() {
                    const now = new Date();
                    const time = now.toLocaleTimeString('es-CO', { hour12: false });
                    document.getElementById('admin-clock').textContent = time;
                }
                updateClock();
                setInterval(updateClock, 1000);

                // Animar contadores iniciales
                setTimeout(() => {
                    const usuariosEl = document.getElementById('usuarios-registrados');
                    const estadisticasEl = document.getElementById('estadisticas');
                    const notificacionesEl = document.getElementById('notificaciones');

                    if (usuariosEl) animateValue(usuariosEl, 0, parseInt(usuariosEl.textContent), 2000);
                    if (estadisticasEl) animateValue(estadisticasEl, 0, parseInt(estadisticasEl.textContent.replace('+', '').replace('%', '')), 2000);
                    if (notificacionesEl) animateValue(notificacionesEl, 0, parseInt(notificacionesEl.textContent), 2000);
                }, 500);
            });
            </script>
            <div class="alert alert-info mt-4">Esta es el área de notificaciones y mensajes importantes del sistema.</div>
            <hr>
            <h4 class="mt-5">Gestión de Usuarios</h4>
            <form class="d-flex mb-3" method="get" action="">
                <input class="form-control me-2" type="search" name="q" placeholder="Buscar por nombre o email" value="{{ q|default('') }}" aria-label="Buscar">
                <button class="btn btn-primary" type="submit">Buscar</button>
            </form>
            <table class="table table-dark table-striped mt-3">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>Rol</th>
                        <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in usuarios %}
                        <tr>
                            <td>{{ user.idUser }}</td>
                            <td>{{ user.nameUser }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.role.value }}</td>
                            <td>
                                <a href="{{ url_for('admin.user_orders', user_id=user.idUser) }}" class="btn btn-info btn-sm mb-1">Ver compras</a>
                                <form method="POST" action="{{ url_for('admin.admin_reset_password', user_id=user.idUser) }}" style="display:inline;">
                                    <button type="submit" class="btn btn-secondary btn-sm mb-1">Restablecer contraseña</button>
                                </form>
                                {% if user.role.value != 'admin' %}
                                    {% if not user.is_blocked %}
                                    <form method="POST" action="{{ url_for('admin.block_user', user_id=user.idUser) }}" style="display:inline;">
                                        <button type="submit" class="btn btn-danger btn-sm mb-1">Bloquear</button>
                                    </form>
                                    {% else %}
                                    <form method="POST" action="{{ url_for('admin.unblock_user', user_id=user.idUser) }}" style="display:inline;">
                                        <button type="submit" class="btn btn-success btn-sm mb-1">Desbloquear</button>
                                    </form>
                                    {% endif %}
                                    <form method="POST" action="{{ url_for('admin.make_admin', user_id=user.idUser) }}" style="display:inline;">
                                        <button type="submit" class="btn btn-warning btn-sm">Hacer admin</button>
                                    </form>
                                {% else %}
                                <span class="badge bg-success">Admin</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
        </main>
    </div>
</div>
{% endblock %}
