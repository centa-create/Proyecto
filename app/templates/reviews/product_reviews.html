<!-- Enlace de accesibilidad para saltar al contenido principal -->
<a href="#main-content" class="skip-link">Saltar a rese√±as</a>


<div class="reviews-container" id="main-content">
  <!-- Cabecera de rese√±as -->
  <header class="reviews-header">
    <h1 class="reviews-title">Rese√±as del Producto</h1>
    <p class="reviews-subtitle">Opiniones de nuestros clientes</p>
  </header>

  {% if reviews %}
    <div class="reviews-list" role="region" aria-label="Lista de rese√±as">
      {% for review in reviews %}
      <article class="review-card" itemscope itemtype="https://schema.org/Review">
        <!-- Cabecera de la rese√±a -->
        <header class="review-header">
          <div class="review-author">
            <div class="review-avatar" aria-hidden="true">
              {{ review.user_name[0]|upper }}
            </div>
            <div class="review-author-info">
              <h4 itemprop="author" itemscope itemtype="https://schema.org/Person">
                <span itemprop="name">{{ review.user_name }}</span>
              </h4>
              <time class="review-date" datetime="{{ review.date.isoformat() }}" itemprop="datePublished">
                {{ review.date.strftime('%d/%m/%Y') }}
              </time>
            </div>
          </div>

          <!-- Sistema de calificaci√≥n -->
          <div class="review-rating" itemprop="reviewRating" itemscope itemtype="https://schema.org/Rating">
            <div class="stars-container" aria-label="Calificaci√≥n: {{ review.rating }} de 5 estrellas">
              {% for i in range(5) %}
                <span class="star {{ 'filled' if i < review.rating else '' }}" aria-hidden="true">‚òÖ</span>
              {% endfor %}
            </div>
            <span class="review-rating-score" aria-label="{{ review.rating }} estrellas">
              {{ review.rating }}/5
            </span>
            <meta itemprop="ratingValue" content="{{ review.rating }}">
            <meta itemprop="bestRating" content="5">
          </div>
        </header>

        <!-- Contenido de la rese√±a -->
        <div class="review-content">
          <p class="review-text" itemprop="reviewBody">{{ review.comment }}</p>
        </div>

        <!-- Imagen de rese√±a (si existe) -->
        {% if review.image_path %}
        <div class="review-image">
          <picture>
            <source
              srcset="{{ url_for('static', filename=review.image_path|replace('.jpg','.webp')|replace('.png','.webp')) }}"
              type="image/webp">
            <img
              src="{{ url_for('static', filename=review.image_path) }}"
              alt="Imagen adjunta a la rese√±a de {{ review.user_name }}"
              loading="lazy"
              itemprop="image">
          </picture>
        </div>
        {% endif %}

        <!-- Acciones de la rese√±a -->
        <div class="review-actions">
          <button class="review-action-btn like" aria-label="Me gusta esta rese√±a">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
              <path d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z"/>
            </svg>
            √ötil
          </button>
          <button class="review-action-btn reply" aria-label="Responder a esta rese√±a">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
              <path d="M6.598 5.013a.144.144 0 0 1 .202.134L6.576 6.01a.144.144 0 0 1-.202.134L3.176 4.51a.144.144 0 0 1 0-.268l3.422-1.634a.144.144 0 0 1 .202.134L6.598 5.013zM2 1h7.09a.145.145 0 0 1 .145.145v7.71a.145.145 0 0 1-.145.145H2a.145.145 0 0 1-.145-.145V1.145A.145.145 0 0 1 2 1z"/>
            </svg>
            Responder
          </button>
        </div>
      </article>
      {% endfor %}
    </div>
  {% else %}
    <!-- Estado vac√≠o -->
    <div class="reviews-empty" role="status" aria-live="polite">
      <div class="reviews-empty-icon" aria-hidden="true">üìù</div>
      <h3 class="reviews-empty-title">A√∫n no hay rese√±as</h3>
      <p class="reviews-empty-text">S√© el primero en compartir tu opini√≥n sobre este producto.</p>
    </div>
  {% endif %}
  {% if current_user.is_authenticated %}
  <!-- Formulario de nueva rese√±a -->
  <section class="review-form-card" aria-labelledby="review-form-title">
    <h2 id="review-form-title" class="review-form-title">Comparte tu opini√≥n</h2>

    <form
      method="post"
      action="{{ url_for('reviews.add_review', product_id=product.id) }}"
      enctype="multipart/form-data"
      aria-label="Formulario para agregar rese√±a"
      novalidate
    >
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <!-- Sistema de calificaci√≥n interactivo -->
      <div class="form-group">
        <label for="rating" class="form-label">¬øQu√© calificaci√≥n le das?</label>
        <div class="rating-input-container" role="group" aria-label="Seleccionar calificaci√≥n">
          <input type="hidden" name="rating" id="rating" value="5" class="rating-input-hidden">
          {% for i in range(5, 0, -1) %}
          <button
            type="button"
            class="rating-input-star {{ 'active' if i == 5 else '' }}"
            data-rating="{{ i }}"
            aria-label="{{ i }} estrella{{ 's' if i > 1 else '' }}"
            title="{{ i }} estrella{{ 's' if i > 1 else '' }}"
          >
            ‚òÖ
          </button>
          {% endfor %}
        </div>
        <div class="rating-display" aria-live="polite" id="rating-display">
          5 estrellas seleccionadas
        </div>
      </div>

      <!-- Campo de comentario -->
      <div class="form-group">
        <label for="comment" class="form-label">Tu comentario</label>
        <textarea
          name="comment"
          id="comment"
          class="form-textarea"
          rows="4"
          placeholder="Comparte tu experiencia con este producto..."
          required
          aria-describedby="comment-help"
          maxlength="1000"
        ></textarea>
        <div id="comment-help" class="form-help">
          M√°ximo 1000 caracteres. Tu opini√≥n es muy valiosa para otros compradores.
        </div>
      </div>

      <!-- Campo de imagen -->
      <div class="form-group">
        <label for="image" class="form-label">Agrega una foto (opcional)</label>
        <input
          type="file"
          name="image"
          id="image"
          class="form-file-input"
          accept="image/*"
          aria-describedby="image-help"
        >
        <div id="image-help" class="form-help">
          Formatos aceptados: JPG, PNG, WebP. Tama√±o m√°ximo: 5MB.
        </div>
      </div>

      <!-- Bot√≥n de env√≠o -->
      <button type="submit" class="review-submit-btn" disabled>
        <span class="btn-text">Publicar rese√±a</span>
        <div class="review-loading" style="display: none;" aria-hidden="true"></div>
      </button>
    </form>

    <!-- Mensajes de estado -->
    <div id="review-message" class="review-message" style="display: none;" role="alert" aria-live="assertive"></div>
  </section>

  <!-- JavaScript para funcionalidad interactiva -->
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const stars = document.querySelectorAll('.rating-input-star');
    const ratingInput = document.getElementById('rating');
    const ratingDisplay = document.getElementById('rating-display');
    const submitBtn = document.querySelector('.review-submit-btn');
    const commentTextarea = document.getElementById('comment');
    const form = document.querySelector('.review-form-card form');

    // Funcionalidad de estrellas interactivas
    stars.forEach((star, index) => {
      star.addEventListener('click', function() {
        const rating = this.dataset.rating;

        // Actualizar estrellas visuales
        stars.forEach((s, i) => {
          s.classList.toggle('active', i >= 5 - rating);
        });

        // Actualizar input oculto
        ratingInput.value = rating;

        // Actualizar texto de accesibilidad
        ratingDisplay.textContent = `${rating} estrella${rating > 1 ? 's' : ''} seleccionada${rating > 1 ? 's' : ''}`;

        // Habilitar bot√≥n de env√≠o
        submitBtn.disabled = false;
      });

      star.addEventListener('mouseenter', function() {
        const rating = this.dataset.rating;
        stars.forEach((s, i) => {
          s.classList.toggle('hover', i >= 5 - rating);
        });
      });

      star.addEventListener('mouseleave', function() {
        stars.forEach(s => s.classList.remove('hover'));
      });
    });

    // Validaci√≥n del formulario
    commentTextarea.addEventListener('input', function() {
      submitBtn.disabled = this.value.trim().length === 0;
    });

    // Manejo del env√≠o del formulario
    form.addEventListener('submit', function(e) {
      const btnText = submitBtn.querySelector('.btn-text');
      const loading = submitBtn.querySelector('.review-loading');

      btnText.style.display = 'none';
      loading.style.display = 'inline-block';
      submitBtn.disabled = true;
    });

    // Inicializar estado del bot√≥n
    submitBtn.disabled = commentTextarea.value.trim().length === 0;
  });
  </script>

  {% else %}
  <!-- Mensaje para usuarios no autenticados -->
  <div class="reviews-empty" role="status">
    <div class="reviews-empty-icon" aria-hidden="true">üîí</div>
    <h3 class="reviews-empty-title">Inicia sesi√≥n para opinar</h3>
    <p class="reviews-empty-text">
      Para compartir tu rese√±a, necesitas tener una cuenta.
      <a href="{{ url_for('auth.login') }}" style="color: var(--review-primary); text-decoration: none; font-weight: 600;">
        Inicia sesi√≥n
      </a>
      o
      <a href="{{ url_for('users.register') }}" style="color: var(--review-primary); text-decoration: none; font-weight: 600;">
        reg√≠strate
      </a>.
    </p>
  </div>
  {% endif %}
</div>
<!-- Fin rese√±as de producto -->
