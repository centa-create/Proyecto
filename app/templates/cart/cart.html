{% extends 'base.html' %}
{% block title %}Carrito | Tienda Virtual{% endblock %}
{% block head %}
<style>
    .cart-container {
        max-width: 950px;
        margin: 40px auto;
        background: #181818;
        border-radius: 1.5rem;
        box-shadow: 0 8px 32px 0 #000a;
        padding: 2.5rem 2rem 2rem 2rem;
        border: 2px solid #fff200;
    }
    .cart-title {
        font-weight: 900;
        color: #fff200;
        margin-bottom: 1.5rem;
        text-align: left;
        font-size: 2.1rem;
        letter-spacing: 0.04em;
        text-shadow: 0 2px 12px #000a;
    }
    .table {
        border-radius: 1rem;
        overflow: hidden;
        background: #222;
        box-shadow: 0 2px 8px #0008;
        color: #fff;
    }
    .table th, .table td {
        vertical-align: middle;
        font-size: 1.05rem;
        color: #fff;
        border-color: #fff20044;
    }
    .table thead {
        background: #181818;
        color: #fff200;
    }
    .btn-outline-primary, .btn-danger, .btn-success {
        border-radius: 8px;
        font-weight: 800;
        font-size: 1rem;
        padding: 0.4rem 1.1rem;
    }
    .cart-total {
        text-align: right;
        margin-top: 2rem;
        font-size: 1.3rem;
        font-weight: 900;
        color: #fff200;
        letter-spacing: 0.04em;
        text-shadow: 0 2px 12px #000a;
    }
    .cart-empty-message {
        background: #23272f;
        border-radius: 1.2rem;
        padding: 2rem 1rem 1.5rem 1rem;
        margin: 2rem auto 1rem auto;
        max-width: 700px;
        box-shadow: 0 0 24px #fff20022, 0 4px 24px #000a;
        text-align: center;
        border: 2px solid #fff200;
        color: #fff;
        animation: fadeIn 1.2s cubic-bezier(.4,2,.3,1);
    }
    .cart-empty-icon {
        font-size: 3.5rem;
        margin-bottom: 0.5rem;
        color: #fff200;
        text-shadow: 0 0 16px #fff20099;
    }
    .cart-empty-title {
        font-size: 1.6rem;
        font-weight: 900;
        color: #fff200;
        margin-bottom: 0.5rem;
        text-shadow: 0 0 8px #fff20044;
    }
    .cart-empty-desc {
        font-size: 1.1rem;
        color: #f5f5f5;
        margin-bottom: 0.5rem;
    }
    .btn-yellow-glow {
        border-radius: 8px;
        font-weight: 700;
        font-size: 1.08rem;
        padding: 0.5rem 1.4rem;
        margin: 0 0.3rem;
        box-shadow: 0 0 12px #fff200, 0 2px 8px #000a;
        outline: none;
        border: 2px solid #fff200;
        color: #fff200;
        background: #181818;
        text-shadow: 0 0 8px #fff20044;
        transition: box-shadow 0.18s, color 0.18s, background 0.18s, border 0.18s;
        display: inline-block;
    }
    .btn-yellow-glow:focus, .btn-yellow-glow:hover {
        box-shadow: 0 0 32px 8px #fff200, 0 4px 32px #000a;
        color: #181818 !important;
        background: #fff200 !important;
        border: 2px solid #fff;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: none; }
    }
    @media (max-width: 768px) {
        .cart-container {
            padding: 1rem;
        }
    }
</style>
{% endblock %}
{% block content %}
<div class="cart-container">
    <div class="cart-title">Mi Carrito</div>
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio</th>
            <th>Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="cartItems"></tbody>
      </table>
    </div>
  <div class="cart-total mb-4" id="cartTotal">Total: 0 COP</div>
    <div class="text-end mb-4">
      <button class="btn btn-success" id="checkoutBtn">Pagar con Stripe</button>
    </div>
    <div id="cartEmpty" class="cart-empty-message" style="display:none;">
      <div class="cart-empty-icon">ðŸ›’</div>
      <div class="cart-empty-title">Â¡Tu carrito estÃ¡ vacÃ­o!</div>
      <div class="cart-empty-desc">Agrega algunos productos increÃ­bles a tu carrito y disfruta de la experiencia SAMMS.FO.</div>
      <a href="/catalog" class="btn btn-yellow-glow mt-3">Explorar Productos</a>
    </div>
</div>

<script>
async function refreshCartUI() {
  const res = await fetch("/api/cart/");
  const data = await res.json();
  const list = document.getElementById("cartItems");
  const totalElem = document.getElementById("cartTotal");
  const emptyElem = document.getElementById("cartEmpty");
  list.innerHTML = "";
  if (data.items.length === 0) {
    totalElem.textContent = "Total: $0";
    emptyElem.style.display = "block";
    document.getElementById("checkoutBtn").disabled = true;
    return;
  }
  emptyElem.style.display = "none";
  let total = 0;
  data.items.forEach(item => {
    const subtotal = item.quantity * item.price_snapshot;
    total += subtotal;
    list.innerHTML += `<tr>
      <td>${item.name}</td>
      <td><input type="number" min="1" value="${item.quantity}" onchange="updateCartItem(${item.id}, this.value)" style="width:60px;"></td>
  <td>${(item.price_snapshot * 4000).toLocaleString('es-CO')} COP</td>
  <td>${(subtotal * 4000).toLocaleString('es-CO')} COP</td>
      <td><button class="btn btn-danger btn-sm" onclick="removeFromCart(${item.id})">Eliminar</button></td>
    </tr>`;
  });
  totalElem.textContent = "Total: " + (total * 4000).toLocaleString('es-CO') + " COP";
  document.getElementById("checkoutBtn").disabled = false;
}


const csrfToken = "{{ csrf_token() }}";

async function updateCartItem(itemId, qty) {
  await fetch("/api/cart/update", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrfToken
    },
    body: JSON.stringify({ id: itemId, quantity: qty })
  });
  await refreshCartUI();
  if (typeof updateCartCount === 'function') {
    updateCartCount();
  }
}

async function removeFromCart(itemId) {
  await fetch("/api/cart/remove", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrfToken
    },
    body: JSON.stringify({ id: itemId })
  });
  await refreshCartUI();
  if (typeof updateCartCount === 'function') {
    updateCartCount();
  }
}

document.getElementById("checkoutBtn").addEventListener("click", async () => {
  const res = await fetch("/api/cart/create-checkout-session", {
    method: "POST",
    headers: {
      "X-CSRFToken": csrfToken
    }
  });
  const data = await res.json();
  if (data.url) {
    window.location = data.url;
  } else {
    alert("Error: " + (data.error || "No se pudo crear la sesiÃ³n"));
  }
});

window.onload = refreshCartUI;
</script>
{% endblock %}
