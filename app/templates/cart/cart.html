{% extends 'base.html' %}
{% block title %}Carrito | Tienda Virtual{% endblock %}
{% block head %}
<style>
    .cart-container {
        max-width: 950px;
        margin: 40px auto;
        background: #181818;
        border-radius: 1.5rem;
        box-shadow: 0 8px 32px 0 #000a;
        padding: 2.5rem 2rem 2rem 2rem;
        border: 2px solid #fff200;
    }
    .cart-title {
        font-weight: 900;
        color: #fff200;
        margin-bottom: 1.5rem;
        text-align: left;
        font-size: 2.1rem;
        letter-spacing: 0.04em;
        text-shadow: 0 2px 12px #000a;
    }
    .table {
        border-radius: 1rem;
        overflow: hidden;
        background: #222;
        box-shadow: 0 2px 8px #0008;
        color: #fff;
    }
    .table th, .table td {
        vertical-align: middle;
        font-size: 1.05rem;
        color: #fff;
        border-color: #fff20044;
    }
    .table thead {
        background: #181818;
        color: #fff200;
    }
    .btn-outline-primary, .btn-danger, .btn-success {
        border-radius: 8px;
        font-weight: 800;
        font-size: 1rem;
        padding: 0.4rem 1.1rem;
    }
    .cart-total {
        text-align: right;
        margin-top: 2rem;
        font-size: 1.3rem;
        font-weight: 900;
        color: #fff200;
        letter-spacing: 0.04em;
        text-shadow: 0 2px 12px #000a;
    }
    @media (max-width: 768px) {
        .cart-container {
            padding: 1rem;
        }
    }
</style>
{% endblock %}
{% block content %}
<div class="cart-container">
    <div class="cart-title">Mi Carrito</div>
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio</th>
            <th>Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="cartItems"></tbody>
      </table>
    </div>
    <div class="cart-total mb-4" id="cartTotal">Total: $0</div>
    <div class="text-end mb-4">
      <button class="btn btn-success" id="checkoutBtn">Pagar con Stripe</button>
    </div>
    <div id="cartEmpty" class="alert alert-info text-center" style="display:none;">No tienes productos en el carrito.</div>
</div>

<script>
async function refreshCartUI() {
  const res = await fetch("/api/cart/");
  const data = await res.json();
  const list = document.getElementById("cartItems");
  const totalElem = document.getElementById("cartTotal");
  const emptyElem = document.getElementById("cartEmpty");
  list.innerHTML = "";
  if (data.items.length === 0) {
    totalElem.textContent = "Total: $0";
    emptyElem.style.display = "block";
    document.getElementById("checkoutBtn").disabled = true;
    return;
  }
  emptyElem.style.display = "none";
  let total = 0;
  data.items.forEach(item => {
    const subtotal = item.quantity * item.price_snapshot;
    total += subtotal;
    list.innerHTML += `<tr>
      <td>${item.name}</td>
      <td><input type="number" min="1" value="${item.quantity}" onchange="updateCartItem(${item.id}, this.value)" style="width:60px;"></td>
      <td>$${item.price_snapshot.toFixed(2)}</td>
      <td>$${subtotal.toFixed(2)}</td>
      <td><button class="btn btn-danger btn-sm" onclick="removeFromCart(${item.id})">Eliminar</button></td>
    </tr>`;
  });
  totalElem.textContent = "Total: $" + total.toFixed(2);
  document.getElementById("checkoutBtn").disabled = false;
}


const csrfToken = "{{ csrf_token() }}";

async function updateCartItem(itemId, qty) {
  await fetch("/api/cart/update", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrfToken
    },
    body: JSON.stringify({ id: itemId, quantity: qty })
  });
  await refreshCartUI();
  if (typeof updateCartCount === 'function') {
    updateCartCount();
  }
}

async function removeFromCart(itemId) {
  await fetch("/api/cart/remove", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrfToken
    },
    body: JSON.stringify({ id: itemId })
  });
  await refreshCartUI();
  if (typeof updateCartCount === 'function') {
    updateCartCount();
  }
}

document.getElementById("checkoutBtn").addEventListener("click", async () => {
  const res = await fetch("/api/cart/create-checkout-session", {
    method: "POST",
    headers: {
      "X-CSRFToken": csrfToken
    }
  });
  const data = await res.json();
  if (data.url) {
    window.location = data.url;
  } else {
    alert("Error: " + (data.error || "No se pudo crear la sesi√≥n"));
  }
});

window.onload = refreshCartUI;
</script>
{% endblock %}
